{% extends 'app1/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">

    <h2>Dashboard</h2>

    <!-- BALANCE CARD -->
    <div class="balance-card">
        Remaining Balance<br>
        <span>₹ {{ remaining_balance }}</span>
    </div>

    <!-- ================= ADD EXPENSE ================= -->
    <div class="add-expense">
        <h3>Add Expense</h3>
        <form method="post">
            {% csrf_token %}
            <select name="category" required>
                <option value="">Select Category</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Shopping">Shopping</option>
                <option value="Others">Others</option>
            </select>

            <input type="number" name="amount" placeholder="Amount" required>
            <button type="submit">Add</button>
        </form>
    </div>

    <!-- ================= MONTH FILTER ================= -->
    <div class="month-filter">
        <form method="get">
            <label>Filter by Month:</label>
            <select name="month" onchange="this.form.submit()">
                <option value="">All</option>
                {% for m in months %}
                <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                    {{ m }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- ================= SUMMARY ================= -->
    <div class="summary">
        <h3>Summary</h3>
        <p><strong>Total Expenses:</strong> ₹{{ monthly_total }}</p>
        <p><strong>Remaining Balance:</strong> ₹{{ remaining_balance }}</p>

        <h4>Category-wise Totals</h4>
        <ul>
            {% for cat, total in category_totals.items %}
                <li>{{ cat }} : ₹{{ total }}</li>
            {% empty %}
                <li>No data</li>
            {% endfor %}
        </ul>
    </div>

    <!-- ================= CHARTS ================= -->
    <div class="chart-section">
        <h3>Expense Charts</h3>

        <div class="chart-box">
            <canvas id="expenseChart"></canvas>
        </div>

        <div class="chart-box">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- ================= HISTORY ================= -->
    <div class="history">
        <h3>Expense History</h3>

        {% if expenses %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.date }}</td>
                    <td>{{ expense.category }}</td>
                    <td>₹{{ expense.amount }}</td>
                    <td>
                        <div class="action-btns">
                            <a href="{% url 'edit_expense' expense.id %}" class="edit-btn">Edit</a>
                            <a href="{% url 'delete_expense' expense.id %}" class="delete-btn">Delete</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No expenses added yet.</p>
        {% endif %}
    </div>

</div>

<!-- ================= CHART JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* -------- PIE CHART -------- */
const pieCtx = document.getElementById('expenseChart').getContext('2d');
new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: [{% for cat in category_totals.keys %}'{{ cat }}',{% endfor %}],
        datasets: [{
            data: [{% for total in category_totals.values %}{{ total }},{% endfor %}],
            backgroundColor: [
                '#60a5fa',
                '#34d399',
                '#fbbf24',
                '#f87171',
                '#a78bfa'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

/* -------- BAR CHART -------- */
const barCtx = document.getElementById('monthlyChart').getContext('2d');
new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: [{% for m in monthly_labels %}'{{ m }}',{% endfor %}],
        datasets: [{
            label: 'Monthly Expense',
            data: [{% for d in monthly_data %}{{ d }},{% endfor %}],
            backgroundColor: '#93c5fd'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>

{% endblock %}
